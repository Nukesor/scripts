#!/usr/bin/env bash
# Usage: ./sway-open-on-scratchpad "identifier" "executable"
#
# identifier can match .app_id or .window_properties.class (case-insensitive).

set -euo pipefail

IDENT="$1"
EXEC="$2"

# Query the tree once
TREE=$(swaymsg -t get_tree)

# Check if a window with the given app_id exists as a scratchpad
check_app_id() {
    local tree="$1"
    local ident="$2"
    jq -e --arg ident "$ident" '
        .. | objects
        | select(.name? == "__i3_scratch")
        | .floating_nodes[]
        | select(.app_id? | test($ident; "i"))
    ' <<<"$tree" >/dev/null
}

# Check if a window with the given class exists as a scratchpad
check_class() {
    local tree="$1"
    local ident="$2"
    jq -e --arg ident "$ident" '
        .. | objects
        | select(.name? == "__i3_scratch")
        | .floating_nodes[]
        | select(.window_properties.class? | test($ident; "i"))
    ' <<<"$tree" >/dev/null
}

# Check if window with app_id matches
if check_app_id "$TREE" "$IDENT"; then
    echo "Found window with matching app_id"
    swaymsg "[app_id=\"$IDENT\"]" scratchpad show
    exit 0
fi

# Check if window with class matches
if check_class "$TREE" "$IDENT"; then
    echo "Found window with matching class"
    swaymsg "[class=\"$IDENT\"]" scratchpad show
    exit 0
fi

# No window found, launch executable
echo "Launching '$EXEC'"
exec "$EXEC" &

# Wait until window appears
max_retries=10
count=0
while [ $count -lt $max_retries ]; do
    TREE=$(swaymsg -t get_tree)

    if check_app_id "$TREE" "$IDENT"; then
        swaymsg "[app_id=\"$IDENT\"]" scratchpad show
        exit 0
    fi

    if check_class "$TREE" "$IDENT"; then
        swaymsg "[class=\"$IDENT\"]" scratchpad show
        exit 0
    fi

    count=$((count + 1))
    sleep 0.5
done

echo "Window did not appear after 5 seconds."
